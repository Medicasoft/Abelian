- name: Install JDK dependencies
  apt: name=python-software-properties state=present

- name: Add JDK repository  
  apt_repository: repo=ppa:webupd8team/java state=present

- name: Configure JDK installer
  debconf: name=oracle-java7-installer question="{{item.question}}" value="{{item.value}}" vtype='select' unseen=no
  with_items:
   - { question: 'shared/accepted-oracle-license-v1-1', value: "true" }

- name: Install jdk
  apt: name=oracle-java7-installer state=present
    
# - name: Install openjdk7-jdk
#   apt: name=openjdk-7-jdk state=present force=yes

- name: Create directory for elasticsearch
  file: path=/opt/elasticsearch state=directory

- name: Download elasticsearch 1.2.1 deb
  get_url: url=https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.2.1.deb dest=/opt/elasticsearch/elasticsearch-1.2.1.deb
  
- name: Install elasticsearch 1.2.1  
  apt: deb=/opt/elasticsearch/elasticsearch-1.2.1.deb 
  
- name: Configure elasticsearch
  lineinfile: line="{{item}}" dest=/etc/elasticsearch/elasticsearch.yml state=present
  with_items:
    - "cluster.name: logstash_cluster"
    - "node.name: logstash_node"
  notify:
    - Restart elasticsearch
    
- name: Start ES on boot
  command: sudo update-rc.d elasticsearch defaults 95 10
  
- name: Install ES curator  
  pip: name=elasticsearch-curator state=present
  
#TODO # Create /etc/cron.daily/elasticsearch_curator Cron Job  
#- name: Set execute permision on /etc/cron.daily/elasticsearch_curator
#  file: path=/etc/cron.daily/elasticsearch_curator mode=770
  
- name: Download Logstash
  get_url: url=https://download.elasticsearch.org/logstash/logstash/logstash-1.4.1.tar.gz dest=/opt/logstash-1.4.1.tar.gz
  
- name: Uncompress Logstash
  shell: chdir=/opt {{item}} creates=/opt/logstash
  with_items:
    - "tar zxf /opt/logstash-1.4.1.tar.gz"        
    - "mv logstash-1.4.1 logstash"
    #- "rm logstash-*.tar.gz"
  sudo: yes
     
- name: Copy Logstash Init Script
  copy: src=files/logstash dest=/etc/init.d/logstash  
  #notify: 
  #  - Restart logstash
    
- name: Set Logstash Init Script permissions 
  file: path=/etc/init.d/logstash mode=770

- name: Start Logstash on boot
  command: update-rc.d logstash defaults 96 04

- name: Create Logstash configuration directory
  file: path=/etc/logstash state=directory
  
- name: Create Logstash log directory
  file: path=/var/log/logstash state=directory
  
- name: Copy Logstash configuration file
  template: src=templates/logstash_server.conf.j2 dest=/etc/logstash/server.conf
  #notify: 
  #  - Restart logstash
    
- name: Copy Logstash configuration files
  copy: src=../src/log/logstash/grok/postfix.grok dest=/opt/logstash/patterns/postfix.grok
  #copy: src={{item}} dest=/opt/logstash/patterns/
  #with_fileglob:
  #  - ../src/log/logstash/grok/*.grok        
  #notify: 
  #  - Restart logstash
    
#TODO # Logrotate job for logstash

- name: Download Kibana
  get_url: url=https://download.elasticsearch.org/kibana/kibana/kibana-3.1.0.tar.gz dest=/opt/kibana-3.1.0.tar.gz
  
- name: Uncompress Kibana
  shell: chdir=/opt {{item}} creates=/opt/kibana
  with_items:
    - "tar zxf /opt/kibana-3.1.0.tar.gz"        
    - "mv kibana-3.1.0 kibana"
    #- "rm kibana-*.tar.gz"
  sudo: yes
 
- name: Configure Kibana elastic search url
  replace: 
    dest=/opt/kibana/config.js
    regexp='elasticsearch:\s"http://"\+window\.location\.hostname\+":9200",'    
    replace='elasticsearch{{':'}} "{{ELASTICSEARCH_HTTP_URL}}",'
    
- name: Configure Kibana dashboards json
  replace: 
    dest=/opt/kibana/config.js
    regexp='default\.json'    
    replace='LogDashb.json'
      
- name: Copy Kibana dashboard
  copy: src=../src/log/kibana/LogDashb.json dest=/opt/kibana/app/dashboards/

- name: Install nginx
  apt: name=nginx state=present

- name: Configure nginx
  template: src=templates/nginx_default.j2 dest=/etc/nginx/sites-available/default
  notify: Restart nginx

- name: Install htpasswd dependency passlib
  apt: name=python-passlib state=present
  
- name: Configure password  
  htpasswd: path=/etc/nginx/conf.d/abelian.htpasswd name={{KIBANA_LOGIN_USERNAME}} password={{KIBANA_LOGIN_PASSWORD}} owner=root group=www-data mode=0640 state=present
  notify: Restart nginx